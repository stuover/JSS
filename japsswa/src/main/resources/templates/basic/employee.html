<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/index}"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head lang="en">
<meta charset="UTF-8">

<script type="text/javascript"
	src="https://uicdn.toast.com/tui.pagination/v3.4.0/tui-pagination.js"></script>
<link rel="stylesheet"
	href="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.css" />
<link rel="stylesheet"
	href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
<script
	src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

</head>

<th:block layout:fragment="content">
	<div class="container-fluid page-body-wrapper">
		<div class="col-12 grid-margin stretch-card">
			<div class="card">
				<div class="card-body">
					<h1 class="card-title">사원 정보</h1>
					<form id="controller">
						<button type="button" id="modifyBtn" class="btn btn-success"
							data-bs-toggle="modal" data-bs-target="#searchModal">수정</button>
						<button id="addEmpBtn">등록</button>
						<div id="grid"></div>
					</form>
				</div>
			</div>
		</div>
	</div>



	<div class="modal fade" id="searchModal" tabindex="-1"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="searchModalLabel">
						<span id="selNo">사원정보 조회</span><span id="selName">사원정보 조회</span>
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<span id="position">현재 직책 : </span> <select id="selPosi">
						<option value="null">선택해주세요</option>
						<option value="사원">사원</option>
						<option value="대리">대리</option>
						<option value="부장">부장</option>
					</select> <br> <span id="deptName">현재 직책 : </span> <select id="selDept">
						<option value="null">선택해주세요</option>
						<option value="인사">인사</option>
						<option value="영업">영업</option>
						<option value="품질">품질</option>
						<option value="설비">설비</option>
						<option value="생산">생산</option>
						<option value="자재">자재</option>
					</select>

				</div>
				<div class="modal-footer">
					<button type="button" id="finBtn" class="btn btn-primary">수정</button>
					<button type="button" id="delBtn" class="btn btn-primary">삭제</button>
				</div>
			</div>
		</div>
	</div>


	<script>
		// GRID 를 생성한다.
		// 나이는 수정할 수 있도록 설정한다.

		window.onload = function() {
			$.ajax({
				url : "/employeeAjax",
				method : "GET",
				dataType : "JSON",
				success : function(result) {
					grid.resetData(result);
				}
			});

			var grid = new tui.Grid({
				el : document.getElementById('grid'),
				scrollX : true,
				scrollY : true,
				rowHeaders : [ 'checkbox' ],
				pageOptions : {
					useClient : true,
					perPage : 10
				},
				columns : [ {
					header : 'No.',
					name : 'rownum',
					sortingType : 'desc',
					sortable : true
				},

				{
					header : '사원번호',
					name : 'empNo',
					sortingType : 'desc',
					sortable : true
				}, {
					header : '이름',
					name : 'empName',
					sortingType : 'desc',
					sortable : true
				}, {
					header : '직책',
					name : 'position',
					sortingType : 'desc',
					sortable : true,
				}, {
					header : '부서',
					name : 'deptName',
					sortingType : 'desc',
					sortable : true
				}, {
					header : '연락처',
					name : 'phoneNum',
					sortingType : 'desc',
					sortable : true
				}, {
					header : 'e-mail',
					name : 'email',
					sortingType : 'desc',
					sortable : true
				},

				{
					header : '입사일',
					name : 'hireDate',
					sortingType : 'desc',
					sortable : true
				} ]
			});

			$('#addEmpBtn').on('click', function(e) {
				e.preventDefault();
				self.location = '/employee/ragister';
			})

			$('#modifyBtn')
					.on(
							'click',
							function(e) {
								e.preventDefault();
								var empNo = null;
								var checkd = null;
								$('input:checkbox')
										.each(
												function(index) {

													if ($(this).is(":checked") == true) {
														checkd = $(this)
																.parent()
																.parent()
																.data('row-key');
														empNo = $(
																'td[data-row-key='
																		+ checkd
																		+ ']')
																.children(
																		':eq(2)')
																.text();

													}

												})
								console.log(empNo);

								$.ajax({
									url : "/serchEmpAjax",
									method : "GET",
									data : {
										empNo : empNo
									},
									dateType : "JSON",
									success : function(result) {
										$('.modal-title #selNo').text(
												result.empNo)
										$('.modal-title #selName').text(
												result.empName);
										if (result.position != null) {
											$('.modal-body #position').text(
													"현재 직책 : "
															+ result.position
															+ '　　　변경할 직책')
										} else {
											$('.modal-body #position').text(
													"직책이 없습니다.　　　　변경할 직책")
										}

										if (result.deptName != null) {
											$('.modal-body #deptName').text(
													"현재 부서 : "
															+ result.deptName
															+ '　　변경할 부서')
										} else {
											$('.modal-body #deptName').text(
													"직책이 없습니다.　　　　변경할 부서")
										}

										$('.modal').modal('show');

									}
								});

								$('#finBtn')
										.on(
												'click',
												function(e) {
													e.preventDefault();
													$
															.ajax({
																url : "/modifyEmpAjax",
																method : "get",
																data : {
																	empNo : $(
																			'.modal-title #selNo')
																			.text(),
																	position : $(
																			'#selPosi')
																			.val(),
																	deptName : $(
																			'#selDept')
																			.val()
																},
																dateType : "json",
																success : function(
																		result) {
																	$(
																			'td[data-row-key='
																					+ checkd
																					+ ']')
																			.children(
																					':eq(4)')
																			.text(
																					$(
																							'#selPosi')
																							.val());
																	$(
																			'td[data-row-key='
																					+ checkd
																					+ ']')
																			.children(
																					':eq(5)')
																			.text(
																					$(
																							'#selDept')
																							.val());
																	$(
																			'#searchModal')
																			.modal(
																					'hide');
																}
															});

												})

								$('#delBtn')
										.on(
												'click',
												function(e) {
													e.preventDefault();
													$
															.ajax({
																url : "/removeEmpAjax",
																method : "get",
																data : {
																	empNo : $(
																			'.modal-title #selNo')
																			.text()
																},
																dateType : "JSON",
																success : function(
																		result) {
																	grid
																			.removeCheckedRows(false);
																	grid.blur();
																	$(
																			'#searchModal')
																			.modal(
																					'hide');

																}
															});

												})
							})
		}
	</script>
</th:block>

</html>
