<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/index}"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head lang="en">
<meta charset="UTF-8">

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css" rel="stylesheet">


<script type="text/javascript"
	src="https://uicdn.toast.com/tui.pagination/v3.4.0/tui-pagination.js"></script>
<link rel="stylesheet"
	href="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.css" />
<link rel="stylesheet"
	href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
<script
	src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>


<th:block layout:fragment="content">
	<div class="container-fluid page-body-wrapper">
		<div class="col-12 grid-margin stretch-card">
			<div class="card">
				<div class="card-body">
					<h1 class="card-title">공통 코드 관리</h1>
					
					<div id="grid"></div>
					
				</div>
			</div>
		</div>
	</div>
	
	
		 <div class="modal fade" id="searchModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="searchModal" aria-hidden="true">
	        <div class="modal-dialog modal-lg modal-dialog-centered" style ="width:650px">
	        <div class="modal-content">
	            <div class="modal-header">
	            <h5 class="modal-title" style="padding-right:25px;">세부코드 조회</h5>
	                 <button id="modalInsBtn" type="button" class="btn btn-primary">등록</button>
	                 <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	            </div>
	            
	            
	            <div class="modal-body">
	            <div id="modalGrid"></div>
	            </div>
	            <div class="modal-footer">
	            	<button id="modalModBtn" type="button" class="btn btn-primary">수정</button>
	            	<button id="modalDelBtn" type="button" class="btn btn-primary">삭제</button>
	            </div>
	        </div>
	        </div>
	    </div>
	
	<script>
		// GRID 를 생성한다.
		// 나이는 수정할 수 있도록 설정한다.


			window.onload = function() {
				const token = $("meta[name='_csrf']").attr("content")
		  		const header = $("meta[name='_csrf_header']").attr("content");
				
				$.ajax({
					url : "/commAjax",
					method : "GET",
					dataType : "JSON",
					success : function(result) {
						grid.resetData(result);
					}
				});
				var grid = new tui.Grid({
					el : document.getElementById('grid'),
					scrollX : true,
					scrollY : true,
					rowHeaders : [ {type : 'checkbox', header:" "},{type :'rowNum'} ],
					pageOptions : {
						useClient : true,
						perPage : 10
					},
					columns : [ 
					{
						header : '공통코드',
						name : 'commCode',
						sortingType : 'desc',
						sortable : true
					}, {
						header : '공통코드명',
						name : 'commName',
						sortingType : 'desc',
						sortable : true
					}, {
						header : '비고',
						name : 'commNote',
						sortingType : 'desc',
						sortable : true,
					}, {
						header : '등록일',
						name : 'insertDate',
						formatter : function(e){
							return e.value.substr(0,10);
						},
						sortingType : 'desc',
						sortable : true
					}, {
						header : '수정일',
						name : 'modifyDate',
						formatter : function(e){
							return e.value.substr(0,10);
						},
						sortingType : 'desc',
						sortable : true
					} ]
				});
			
		
			grid.on('check', function (e) {
                var checkRows = grid.getCheckedRowKeys();
                checkRows.forEach(function( key, idx){                      
                   if(key != e.rowKey){
                      grid.uncheck(key);
                   }
                });
            });
			


	 		  $('#searchModal').on('shown.bs.modal', function (e) {
					console.log('open');
					setTimeout(()=> modalGrid.refreshLayout(), 300);
	  			})

			 var modalGrid = new tui.Grid({
					el : document.getElementById('modalGrid'),
					scrollX : true,
					scrollY : true,
					rowHeaders : [ {type : 'checkbox', header:" "},{type :'rowNum'} ],
					pageOptions : {
						useClient : true,
						perPage : 5
					},
					columns : [ 
					{
						header : '세부코드',
						name : 'detaCode',
						sortingType : 'desc',
						editor: 'text',
						sortable : true
					}, {
						header : '세부코드명',
						name : 'detaName',
						sortingType : 'desc',
						editor: 'text',
						sortable : true
					}, {
						header : '비고',
						name : 'detaNote',
						sortingType : 'desc',
						editor: 'text',
						sortable : true,
					}, {
						header : '등록일',
						name : 'detaInsertDate',
						formatter : function(e){
							if(e.value == null){
								return;
							}else{
								return e.value.substr(0,10);
							}
														
						},
						sortingType : 'desc',				
						sortable : true
					}, {
						header : '수정일',
						name : 'detaModifyDate',
						sortingType : 'desc',
						formatter : function(e){
							if(e.value == null){
								return;
							}else{
								return e.value.substr(0,10);
							}
						},
						sortable : true
					} ]
			});
	 		
	 		 var commCode;
			grid.on('click',function(e){
				commCode = grid.getRow(e.rowKey).commCode;
				 grid.setSelectionRange({
			            start: [e.rowKey, 0],
			            end: [e.rowKey, grid.getColumns().length - 1]
			     	});
					$('#searchModal').modal('show');
				
				 $.ajax({
					url : "/detailAjax",
					dataType: "json",
					data : {commCode : grid.getRow(e.rowKey).commCode },
					success : function(result) {
						
						if(result != null){
							modalGrid.resetData(result);					
						}else {
							alert("결과 값이 없습니다.")
						}
					}
				});
				 

			});
			
			
			$('#modalInsBtn').on('click', function(){
				modalGrid.prependRow();
			})
			
			
			$('#modalModBtn').on('click',function(){
				console.log(modalGrid.getCheckedRows());
				console.log(commCode);
				let arr = JSON.stringify( modalGrid.getCheckedRows() );
				arr = arr.substr(1,arr.length-2)
				var data =  modalGrid.getCheckedRows();
				
				$.ajax({
					url : "/modifyDetailsAjax",
					contentType : "application/json",
					data :  JSON.stringify( {code: commCode, list : data }),
					method :"post",
					dataType : "json",
					beforeSend: function(xhr){
						xhr.setRequestHeader(header, token);    
					},
					success : function(result){
						console.log(result);
						alert('등록완료!');
					}
				});
			});
		}
			  
	</script>

</th:block>
</html>