<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/index}"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>


<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />

</head>
<th:block layout:fragment="content">
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js"></script>
	<link
		href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css"
		rel="stylesheet">

	<script type="text/javascript"
		src="https://uicdn.toast.com/tui.pagination/v3.4.0/tui-pagination.js"></script>
	<link rel="stylesheet"
		href="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.css" />
	<link rel="stylesheet"
		href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
	<script
		src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
	<link rel="stylesheet"
		href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
	<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>


	<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>

	<div class="container-fluid page-body-wrapper">

		<div class="col-12 grid-margin stretch-card">
			<div class="card">
				<div class="card-body">
					<h4 class="page-title">주문서 관리</h4>
					

					<input id="name" type="hidden" th:value="${#authentication.principal.empName}"> 
					<div>
						
									<button id="searchBtn" type="button" class="btn btn-success"
										data-bs-toggle="modal" data-bs-target="#searchModal">거래처 찾기</button>
					</div>

					<div class="row"></div>
					
					<div id="grids"></div>
					<div id="grid"></div>

					<div>
						<form>
							<button id="addBtn" type="button" class="btn btn-success">추가</button>
							<button id="insertBtn" type="button" class="btn btn-success">등록</button>
							<button id="updateBtn" type="button" class="btn btn-success">수정</button>
							<button id="delBtn" type="button" class="btn btn-success">삭제</button>
						</form>
					</div>


				</div>

			</div>
		</div>

	</div>



	<div class="modal fade" id="searchModal" tabindex="-1"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="searchModalLabel">거래처 찾기</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<input type="text" id="modalInput" name="cust">
					<button id="custSearch" type="button" class="btn btn-primary">찾기</button>
					<div id="modalGrid"></div>
				</div>
				<div class="modal-footer">
					<button id="chooseBtn" type="button" class="btn btn-primary">선택</button>
				</div>
			</div>
		</div>
	</div>

	<script>
	  

		const token = $("meta[name='_csrf']").attr("content")
		const header = $("meta[name='_csrf_header']").attr("content")
  		const Grid = tui.Grid;
  		
		let gridsData = [{}];
  		const grids = new Grid({
		      el: document.getElementById('grids'),
		      data: gridsData,
		      scrollX: false,
		      scrollY: false,
		      columns: [
				     {
					  header: '거래처 명',
					  name: 'customerName',
					  editor: 'text'
					 },
					 {
					  header: '주소',
					  name: 'custAddr',
					  editor: 'text'
				     },
				     {
					  header: '메일',
					  name: 'custMail',
					  editor: 'datePicker'
					 }, 
				     {
				      header: '연락처',
				      name: 'custTel',
				      editor: 'text'
				    
				     },	
				     {
					  header: '주문명',
					  name: 'ordName',
					  editor: 'text'
					  
					 },
					 {
					  header: '담당자',
					  name: 'empName',
					  editor: 'text'
					 }
			      ],
			      
			        
			    });

			grids.on('check', ev => {
		      console.log('check!', ev);
		    });

		    grids.on('uncheck', ev => {
		      console.log('uncheck!', ev);
		    });

		    grids.on('focusChange', ev => {
		      console.log('change focused cell!', ev);
		    });
		
		    
		var unit;
		var count;
  		let gridData = [{}];
  		const grid = new Grid({
		      el: document.getElementById('grid'),
		      data: gridData,
		      rowHeaders: ['checkbox'],
		      scrollX: false,
		      scrollY: false,
		      columns: [
		    	     {
					  header: '품목명',
					  name: 'itemName',
					  editor: 'text'
					 },
				     {
					  header: '납부예정일',
					  name: 'outDate',
					  editor: 'datePicker'
					 },
					 {
					  header: '단가',
					  name: 'unitPrice'
				     },
				     {
					  header: '수량',
					  name: 'ordCount',
					  editor: 'text'
					 }, 
					 {
				      header: '판매가격',
				      name : 'eachPrice'
				     }
			      ],
			      summary: {
			          height: 40,
			          position: 'bottom', // or 'top'
			          columnContent: {
			           
			        	  eachPrice: {
			              template: function(valueMap) {
			                return `TOTAL: ${valueMap.sum}`;
			              }
			            }
			          }
			        }
			    });

		    grid.on('check', ev => {
		      console.log('check!', ev);
		    });

		    grid.on('uncheck', ev => {
		      console.log('uncheck!', ev);
		    });

		    grid.on('focusChange', ev => {
		      console.log('change focused cell!', ev);
		    });
		    
		    
	
		    window.onload = function(){
		    
		    	grids.setValue(0, 'empName', $('#name').val(), false);
		    	
				$.ajax({
			    	url : "/itemNamelist",
			    	method : "GET",
			        dataType : "JSON", 
			        success : function(result){
			        	grid.resetData(result);
			        	console.log(result);
			        }
				
			    });	
				
				 $('#searchModal').on('shown.bs.modal', function (e) {
						console.log('open');
						setTimeout(()=> modalGrid.refreshLayout(), 1);
		  			});
				
		    }; 
		    
		    grid.on('editingFinish', function(e){
		  
		    	var unit = grid.getRow(e.rowKey).unitPrice;
		    	var count = grid.getRow(e.rowKey).ordCount;
		    	
		    	grid.setValue(e.rowKey, 'eachPrice', unit*count, false);

		    })
		    
			
				const modalGrid = new Grid({
		               el: document.getElementById('modalGrid'),
		 		      rowHeaders: ['checkbox'],
		               scrollX: false,
		               scrollY: false,
		             pageOptions: { 
		                useClient: true,
		                perPage: 5 
		                },
		               columns: [
		            	   {
			                   header: '거래처 코드',
			                   name: 'customerId'
			                 },
		                 {
		                   header: '거래처명',
		                   name: 'customerName'
		                 },
		                 {
		                   header: '연락처',
		                   name: 'custTel'
		                 },
		                 {
		                   header: '주소',
		                   name: 'custAddr'
		                 },              
		                 {
		                   header: '메일주소',
		                   name: 'custMail'
		                 }     
		               ]
		             });

		            modalGrid.on('check', ev => {
		               console.log('check!', ev);
		             });

		            modalGrid.on('uncheck', ev => {
		               console.log('uncheck!', ev);
		             });

		            modalGrid.on('focusChange', ev => {
		               console.log('change focused cell!', ev);
		             });
		            
		           
		        	
		
			 
		            
		           $('#custSearch').on('click', function(){
		        	   
		        	   const result = $('#modalInput').val();
		        	   $('#modalInput').val('');
		        	   
		        	   $.ajax({
		        		   url : "/custList",
		        		   method : "GET",
		        		   data : {'result' : result},
		        		   dataType : "JSON",
		        		   success : function(result){
		        			   modalGrid.resetData(result);
		        			   modalGrid.refreshLayout();
		        			  
		        		   }
		        		   
		        	   })
		           }) 

		           var custInfo = [];
		           var custId = '';
		           $('#chooseBtn').on('click', function(){
		        	   
		        	   custId = modalGrid.getCheckedRows()[0].customerId;
		        	   custInfo = [{customerName : modalGrid.getCheckedRows()[0].customerName, custAddr : modalGrid.getCheckedRows()[0].custAddr, custMail : modalGrid.getCheckedRows()[0].custMail, custTel : modalGrid.getCheckedRows()[0].custTel}]
		        	   
		        	   $('#searchModal').modal('hide');

		        	   $('#searchModal').on('hidden.bs.modal', function(e){
		        		   gridsData = custInfo;
		        		   grids.resetData(custInfo);
			        	   $.ajax({
			        		   url : "/custInfo",
			        		   method : "GET",
			        		   data : {customerId : custId},
			        		   dataType : "JSON",
			        		   success : function(result){
			        			   grids.resetData(result);
			        			   grids.setValue(0, 'empName', $('#name').val(), false);
			        			   modalGrid.refreshLayout();
			        			  
			        		   }
			        		   
			        	   })
		        	   })
		        	  
		        	   
		           }) 
		         
		           
		           $('#insertBtn').on('click', function(){
		        	   console.log(grid.getCheckedRows())
		        	   console.log(customerId)
		        	   var data = grid.getCheckedRows();
		        	   $.ajax({
		        		   url : "/entireRegister",
		        		   contentType : "application/json",
		        		   data : JSON.stringify( { commInfo : customerId, list : data } ),
		        		   method : "post",
		        		   dataType:"json",
		        		   beforeSend : function(xhr){
		        			   xhr.setRequestHeader(header, token);
		        			   
		        		   },
		        		   success:function(result){
	
		        			   alert('등록 완료 되었습니다')
		        		   }
		        	   });
		        	   
		        	  
		        		  
		           })
		  
				

  			

		
  		</script>

</th:block>

</html>