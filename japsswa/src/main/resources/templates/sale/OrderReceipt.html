<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/index}"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<th:block layout:fragment="content">
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js"></script>
	<link
		href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css"
		rel="stylesheet">

	<script type="text/javascript"
		src="https://uicdn.toast.com/tui.pagination/v3.4.0/tui-pagination.js"></script>
	<link rel="stylesheet"
		href="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.css" />
	<link rel="stylesheet"
		href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
	<script
		src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
	<link rel="stylesheet"
		href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
	<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>


	<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>


	<div class="container-fluid page-body-wrapper">

		<div class="col-12 grid-margin stretch-card">
			<div class="card">
				<div class="card-body">
					<h4 class="page-title">주문서 작성</h4>


					<div>
						<table class="customer">
							<tr>
								<td>거래처</td>
								<td><input type="text" id="cust" name="cust">
									<button id="searchBtn" type="button" class="btn btn-success"
										data-bs-toggle="modal" data-bs-target="#searchModal">찾기</button></td>

							</tr>
							<tr>
								<td>연락처</td>
								<td><input type="text" id="tel" name="tel"></td>
							</tr>
							<tr>
								<td>주소</td>
								<td><input type="text" id="addr" name="addr"></td>
							</tr>
							<tr>
								<td>메일주소</td>
								<td><input type="email" id="mail" name="mail"></td>
							</tr>
						</table>
					</div>

					<div class="row"></div>

					<div id="grid"></div>


					<div>
						<form>
							<button id="insertBtn" type="button">등록</button>
						</form>
					</div>


				</div>

			</div>
		</div>

	</div>



	<div class="modal fade" id="searchModal" tabindex="-1"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="searchModalLabel">거래처 찾기</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<input type="text" id="modalInput" name="cust">
					<button id="custSearch" type="button" class="btn btn-primary">찾기</button>
					<div id="modalGrid"></div>
				</div>
				<div class="modal-footer">
					<button id="chooseBtn" type="button" class="btn btn-primary">선택</button>
				</div>
			</div>
		</div>
	</div>

	<script>

  		const Grid = tui.Grid;
  		
  		let gridData = [{}];
  		const grid = new Grid({
		      el: document.getElementById('grid'),
		      data: gridData,
		      rowHeaders: ['checkbox'],
		      scrollX: false,
		      scrollY: false,
		      columns: [
			        
				     {
					  header: '주문명',
					  name: 'ordName',
					  editor: 'text'
					 },
					 {
					  header: '품목명',
					  name: 'itemName'
				     },
				     {
				      header: '주문날짜',
				      name: 'ordDate',
				      editor: 'datePicker'
				     },
				     {
					  header: '납부예정날짜',
					  name: 'outDate',
					  editor: 'datePicker'
					 }, 
				     {
				      header: '단가',
				      name: 'unitPrice',
				    	  editor: 'text'
				     },	
				     {
					  header: '수량',
					  name: 'ordCount',
					  editor: 'text'
					 },
					 {
				      header: '판매가격',
					  name: 'eachPrice',
					  editor: 'text'
				     },
					 {
					  header: '담당자',
				      name: 'empName',
					  editor: 'text'
					 }
			      ],
			      summary: {
			          height: 40,
			          position: 'bottom', // or 'top'
			          columnContent: {
			           
			        	  eachPrice: {
			              template: function(valueMap) {
			                return `TOTAL: ${valueMap.sum}`;
			              }
			            }
			          }
			        }
			    });

		    grid.on('check', ev => {
		      console.log('check!', ev);
		    });

		    grid.on('uncheck', ev => {
		      console.log('uncheck!', ev);
		    });

		    grid.on('focusChange', ev => {
		      console.log('change focused cell!', ev);
		    });
		
		    window.onload = function(){
				$.ajax({
			    	url : "/itemNamelist",
			    	method : "GET",
			        dataType : "JSON", 
			        success : function(result){
			        	grid.resetData(result);
			        	console.log(result);
			        }
				
			    });	
				
				 $('#searchModal').on('shown.bs.modal', function (e) {
						console.log('open');
						setTimeout(()=> modalGrid.refreshLayout(), 1);
		  			});
				
				    	
		    };
		    
			
				const modalGrid = new Grid({
		               el: document.getElementById('modalGrid'),
		 		      rowHeaders: ['checkbox'],
		               scrollX: false,
		               scrollY: false,
		             pageOptions: { 
		                useClient: true,
		                perPage: 5 
		                },
		               columns: [
		                 {
		                   header: '거래처명',
		                   name: 'customerName'
		                 },
		                 {
		                   header: '연락처',
		                   name: 'custTel'
		                 },
		                 {
		                   header: '주소',
		                   name: 'custAddr'
		                 },              
		                 {
		                   header: '메일주소',
		                   name: 'custMail'
		                 }     
		               ]
		             });

		            modalGrid.on('check', ev => {
		               console.log('check!', ev);
		             });

		            modalGrid.on('uncheck', ev => {
		               console.log('uncheck!', ev);
		             });

		            modalGrid.on('focusChange', ev => {
		               console.log('change focused cell!', ev);
		             });
		            
		           
		            
		            
		           $('#custSearch').on('click', function(){
		        	   
		        	   const result = $('#modalInput').val();
		        	   $('#modalInput').val('');
		        	   
		        	   $.ajax({
		        		   url : "/custList",
		        		   method : "GET",
		        		   data : {'result' : result},
		        		   dataType : "JSON",
		        		   success : function(result){
		        			   modalGrid.resetData(result);
		        			   modalGrid.refreshLayout();
		        			  
		        		   }
		        		   
		        	   })
		           }) 

		           
		           $('#chooseBtn').on('click', function(){
		        	   
		        	   $('#searchModal').modal('hide');

		        	   const result = $('#modalInput').val();
		        	   $('#modalInput').val('');
		        	   
		        	   $.ajax({
		        		   url : "/custList",
		        		   method : "GET",
		        		   data : {'result' : result},
		        		   dataType : "JSON",
		        		   success : function(result){
		        			   modalGrid.resetData(result);
		        			   modalGrid.refreshLayout();
		        			  
		        		   }
		        		   
		        	   })
		        	   
		        	   $('#cust').val(modalGrid.getCheckedRows()[0].customerName);
		        	   $('#tel').val(modalGrid.getCheckedRows()[0].custTel);
		        	   $('#addr').val(modalGrid.getCheckedRows()[0].custAddr);
		        	   $('#mail').val(modalGrid.getCheckedRows()[0].custMail);
		        	   
		           }) 
				

  			

			
			
  		</script>

</th:block>

</html>