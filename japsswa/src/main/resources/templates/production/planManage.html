<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/index}"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
<head>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<th:block layout:fragment="content">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script type="text/javascript" src="https://uicdn.toast.com/tui.pagination/v3.4.0/tui-pagination.js"></script>
<link rel="stylesheet" href="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.css" />
<link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>


<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
	
 		<div class="container-fluid page-body-wrapper">

 			<div class="col-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <h4 class="page-title">생산 계획 관리</h4>
                  
                  <input id="afterSearch" type="text" name="selectResult" value="insert">

                  <div class="btn-group">
                  	<div>
                  	<button type="button" id="searchBtn" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#searchModal">조회</button>
                  	<button id="saveBtn" class="btn btn-primary">저장</button>
                  	<button id="deleteBtn" class="btn btn-danger">삭제</button>
                  	</div>

                  </div>
                  
                  <div id="grid2"></div>
                  
                  <div class="row">
                  	
                  </div>
                  
                  <div id="grid"></div>
                  
				            
                </div>
              
              </div>
            </div>

  		</div>
  		
		
  		
	    <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	        <div class="modal-dialog modal-dialog-centered">
	        <div class="modal-content">
	            <div class="modal-header">
	            <h5 class="modal-title" id="searchModalLabel">생산계획 조회</h5>
	            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	            </div>
	            <div class="modal-body">
	            <div id="modalGrid"></div>
	            </div>
	            <div class="modal-footer">
	            <button id="modalSelectBtn" type="button" class="btn btn-primary">선택</button>
	            </div>
	        </div>
	        </div>
	    </div>
  		

  		<script>
  		const token = $("meta[name='_csrf']").attr("content")
  		const header = $("meta[name='_csrf_header']").attr("content");
  		
  		
  		const Grid = tui.Grid;
		
  		let gridData2 = [{}];
  		
  		const grid2 = new Grid({
		      el: document.getElementById('grid2'),
		      data: gridData2,
		      scrollX: false,
		      scrollY: false,
		      columns: [
		        {
  		      header: '계획명',
  		      name: 'planName',
  		      editor: 'text'
  		     },
    		    {
    		     header: '계획날짜',
    		     name: 'planDate',
    		     formatter: function (e) {
    		    	 
    		    	 let result = e.value;
    		    	 if(result == null) {
    		    		 result = e.value
    		    		 return;
    		    	 }else {
    		    		 result = e.value.substr(0,10)
 		        		return result;
    		    	 }
                 	},
    		     editor:  'datePicker'
  	             
    		    }, 		    
    		    {
    		     header: '담당자',
    		     name: 'empName',
    		     editor: 'text'
    		    }	   
		      ]
		    });
  		
		    grid2.on('check', ev => {
	  		      console.log('check!', ev);
	  		    });

  		    grid2.on('uncheck', ev => {
    		      console.log('uncheck!', ev);
    		    });
  		    
  		    grid2.on('focusChange', ev => {
    		      console.log('change focused cell!', ev);
    		    });
  		
  		
  		  let gridData = [];
  		 
  		 const grid = new Grid({
  		      el: document.getElementById('grid'),
  		      data: gridData,
  		      rowHeaders: ['checkbox'],
  		      scrollX: false,
  		      scrollY: true,
  		      columns: [
  		        {
  		          header: '제품명',
  		          name: 'itemName'
  		        },
  		        {
  		          header: '계획 수량',
  		          name: 'planAmount',   
      		      editor: 'text'
  		        },
      		     {
        		  header: '계획시작날짜',
        		  name: 'planStart',
      		      formatter: function (e) {
        		    	 
    		    	  let result = e.value;
    		    	  if(result == null) {
    		    		  result = e.value
    		    		  return;
    		    	  }else {
    		    		  result = e.value.substr(0,10)
 		        		  return result;
						  }
                  },      		  
        		  editor: 'datePicker'
        		 },
        		 {
           		  header: '계획완료날짜',
           		  name: 'planEnd',
      		      formatter: function (e) {
        		    	 
    		    	  let result = e.value;
    		    	  if(result == null) {
    		    		  result = e.value
    		    		  return;
    		    	  }else {
    		    		  result = e.value.substr(0,10)
 		        		  return result;
						  }
                  },  
           		  editor:  'datePicker'
           		 },    		        
      		     {
      		      header: '작업우선순위',
      		      name: 'planPriority',
      		      editor: 'text'
      		     }	   
  		      ]
  		    });

  		    grid.on('check', ev => {
  		      console.log('check!', ev);
  		    });

  		    grid.on('uncheck', ev => {
  		      console.log('uncheck!', ev);
  		    });

  		    grid.on('focusChange', ev => {
  		      console.log('change focused cell!', ev);
  		    });

  		  
  		    
  		  window.onload = function(){
  			  
  			  $('#afterSearch').css('display', 'none');
	  		    $.ajax({
	  		        url : "/itemListInfoAjax",
	  		        method :"GET",
	  		        dataType : "JSON",
	  		        success : function(result){
	  		            grid.resetData(result);
	  		            console.log(result);
	  		        } 
	  		    });
	  		    
	  		  $('#searchModal').on('shown.bs.modal', function (e) {
					console.log('open');
					setTimeout(()=> modalGrid.refreshLayout(), 300);
	  			})
  		  };
  		  
          let modalGridData = [];
          
          const modalGrid = new Grid({
               el: document.getElementById('modalGrid'),
               data: modalGridData,
               rowHeaders: ['checkbox'],
               scrollX: false,
               scrollY: false,
             pageOptions: { 
                useClient: true,
                perPage: 5 
                },
               columns: [
                 {
                   header: '생산계획코드',
                   name: 'planId'
                 },
                 {
                   header: '계획명',
                   name: 'planName'
                 },
                 {
                   header: '계획날짜',
                   name: 'planDate',
   		           formatter: function (e) {
 		        	  return e.value.substr(0,10)
                   }
                   
                 },              
                 {
                   header: '담당자',
                   name: 'empName'
                 }     
               ]
             });

            modalGrid.on('check', ev => {
               console.log('check!', ev);
             });

            modalGrid.on('uncheck', ev => {
               console.log('uncheck!', ev);
             });

            modalGrid.on('focusChange', ev => {
               console.log('change focused cell!', ev);
             });

  			
  		   
  		  
  		    $('#searchBtn').click(function (){
  											$.ajax({
  												url : "/modalPlanListAjax",
  												method :"GET",
  												dataType : "JSON",
  												success : function(result){
  													console.log(result);
  													modalGrid.resetData(result);
  												}
  											});
  											
  														
  		  									});
  		    
  		    let planInfo = [];
			let planCode = '';
			$('#modalSelectBtn').click(function () {
				planCode = modalGrid.getCheckedRows()[0].planId;
				planInfo = [{planName : modalGrid.getCheckedRows()[0].planName , planDate : modalGrid.getCheckedRows()[0].planDate , empName : modalGrid.getCheckedRows()[0].empName}];
				 console.log('planId = ' + planCode);
				 console.log(planInfo);
				 if(modalGrid.getCheckedRows().length > 1) {
					 
					 alert('수정 및 삭제할 생산계획은 하나만 선택가능합니다.');
					 
				 } else {
					 
				 $('#searchModal').modal('hide');
				 
				 $('#searchModal').on('hidden.bs.modal', function (e) {
					 gridData2= planInfo;
					 grid2.resetData(planInfo);
					 
					 $.ajax({
							url : "/planSearchResultAjax",
							data : {planId : planCode},
							method :"GET",
							dataType : "JSON",
							success : function(result){
								console.log('result : '+ result);
								grid.resetData(result);
								
							}
						});
					 $('#afterSearch').attr('value', 'modify');
					 
				 });	

				 }
				 

			})
		
  			

  			$('#saveBtn').click(function (){
  											grid2.finishEditing();
  											grid2.getData();
  											
  											grid.finishEditing();
  											grid.getCheckedRows();
  											
  											
  											console.log(grid2.getData());
  											console.log(grid.getData());
  											
  											if( $('#afterSearch').val() == 'insert' ) {
  												console.log('등록처리 해야 함.');
	  											$.ajax({
	  												url : "/savePlanAjax",
	  												contentType : "application/json", 
	  												data :  JSON.stringify(  {head : grid2.getData()[0], detailList : grid.getCheckedRows()}  ) ,
	  												method :"POST",
	  												dataType : "JSON",
	  												beforeSend: function(xhr){
	  													xhr.setRequestHeader(header, token);
	  												},
	  												success : function(result){
	  													console.log(result);
	  													alert('등록완료!');
	  													
	  												}
	  											});
	  											
  											} else {
  												console.log('수정처리 해야 함.');
  											}
		

  			})
  			
  			
		

			
  		</script>
    
	</th:block>

</html>